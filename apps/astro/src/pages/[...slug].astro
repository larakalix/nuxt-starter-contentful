---
import Layout from "../layouts/Layout.astro";
import { Error as ErrorComponent } from "@starter/ui/organisms/error";
import { FunnelPageSections } from "@starter/ui/pages/funnel-page-sections";
import { getPostsLinks, getPagesSlugs } from "@starter/content";
import { loadFunnelPage } from "../server/funnel-page";
import type { OnNavigate } from "@starter/ui/atoms/versatile-link";

export async function getStaticPaths() {
    const [slugs, paths] = await Promise.all([
        getPagesSlugs(),
        getPostsLinks(),
    ]);

    return [
        { params: { slug: "" } },
        ...slugs.map(({ slug }) => ({ params: { slug } })),
        ...paths.map(({ href }) => ({ params: { slug: href } })),
    ];
}

const { slug } = Astro.params;
const { funnelPage, error } = await loadFunnelPage(slug);

const onNavigate: OnNavigate = (href, event) => {
    event?.preventDefault();
    window.location.assign(href);
};
---

<Layout>
    <!-- Error state -->
    {error && <ErrorComponent message={error?.message} />}

    <!-- Success state -->
    <FunnelPageSections
        client:visible
        funnelPage={{
            ...funnelPage?.page,
            skipWrapper: false,
        }}
        onNavigate={onNavigate}
    />
</Layout>
